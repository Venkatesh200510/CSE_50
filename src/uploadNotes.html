<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Notes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="./output.css" rel="stylesheet">
</head>

<body>
    <button onclick="goHome()"
        class="bg-gray-800 hover:bg-black text-white font-bold py-2 px-6 rounded-full shadow-lg m-4">
        Back</button>
    <div class="container mt-5">

        <!-- Upload Form -->
        <div class="card shadow-lg p-4 rounded-3">
            <h3 class="text-center mb-4">Faculty Upload Notes</h3>
            <form id="uploadForm">

                <!-- Semester -->
                <div class="mb-3">
                    <label for="semester" class="form-label">Select Semester</label>
                    <select class="form-select" id="semester" required>
                        <option value="">-- Choose Semester --</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                </div>

                <!-- Section -->
                <div class="mb-3">
                    <label for="section" class="form-label">Select Section</label>
                    <select class="form-select" id="section" required>
                        <option value="">-- Choose Section --</option>
                        <option>A</option>
                        <option>B</option>
                        <option>C</option>
                    </select>
                </div>

                <!-- Subject -->
                <div class="mb-3">
                    <label for="subject" class="form-label">Select Subject</label>
                    <select class="form-select" id="subject" required>
                        <option value="">-- Choose Subject --</option>
                    </select>
                </div>

                <!-- File Upload -->
                <div class="mb-3 w-55 lg:w-25 ">
                    <label for="file" class="form-label">Upload Notes (PDF/DOC/PPT)</label>
                    <input type="file" class="form-control" id="file" accept=".pdf,.doc,.docx,.ppt,.pptx" required>
                </div>

                <button type="submit" class="btn btn-primary w-100">Upload Notes</button>
            </form>
        </div>

        <!-- Uploaded Notes Section -->
        <div class="card shadow-lg p-4 rounded-3 mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Uploaded Notes</h4>
                <button id="deleteAllBtn" class="btn btn-sm btn-danger" disabled>Delete All</button>
            </div>
            <div id="notesContainer">
                <p class="text-muted">Select Semester, Section & Subject to view notes.</p>
            </div>
        </div>
    </div>

    <script>
        const semesterSelect = document.getElementById("semester");
        const sectionSelect = document.getElementById("section");
        const subjectSelect = document.getElementById("subject");
        const notesContainer = document.getElementById("notesContainer");
        const deleteAllBtn = document.getElementById("deleteAllBtn");

        // 1Ô∏è‚É£ Update subject dropdown when semester changes
        semesterSelect.addEventListener("change", async function () {
            const sem = this.value;
            subjectSelect.innerHTML = '<option value="">-- Choose Subject --</option>';

            if (sem) {
                try {
                    const res = await fetch(`/api/notes/subjects?semester=${sem}`);
                    const subs = await res.json();

                    subs.forEach(sub => {
                        const option = document.createElement("option");
                        option.value = sub.subject_code;
                        option.textContent = sub.subject_name;
                        subjectSelect.appendChild(option);
                    });
                } catch (err) {
                    console.error("üî• Error fetching subjects:", err);
                    alert("Failed to load subjects!");
                }
            }

            renderNotes();
        });

        // 2Ô∏è‚É£ Refresh notes when section/subject change
        sectionSelect.addEventListener("change", renderNotes);
        subjectSelect.addEventListener("change", renderNotes);

        // 3Ô∏è‚É£ Handle form submission (upload)
        document.getElementById("uploadForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const semester = semesterSelect.value;
            const section = sectionSelect.value;
            const subject = subjectSelect.value;
            const fileInput = document.getElementById("file");
            const file = fileInput.files[0];

            if (!semester || !section || !subject) {
                alert("Please select semester, section, and subject.");
                return;
            }
            if (!file) {
                alert("Please select a file.");
                return;
            }

            const formData = new FormData();
            formData.append("semester", semester);
            formData.append("section", section);
            formData.append("subject", subject);
            formData.append("file", file);

            try {
                const res = await fetch("/api/notes/upload", {
                    method: "POST",
                    body: formData
                });

                const result = await res.json();
                alert(result.message || "Note uploaded!");
                fileInput.value = "";
                renderNotes();
            } catch (err) {
                console.error("üî• Upload error:", err);
                alert("Upload failed!");
            }
        });

        // 4Ô∏è‚É£ Render notes only for current selection
        // 4Ô∏è‚É£ Render notes only for current selection
        async function renderNotes() {
            const semester = semesterSelect.value;
            const section = sectionSelect.value;
            const subject = subjectSelect.value;

            notesContainer.innerHTML = "";

            if (!semester || !section || !subject) {
                notesContainer.innerHTML = '<p class="text-muted">Select Semester, Section & Subject to view notes.</p>';
                deleteAllBtn.disabled = true;
                return;
            }

            try {
                // ‚úÖ Fetch notes from backend
                const res = await fetch(`/api/notes?semester=${semester}&section=${section}&subject=${subject}`);
                const notes = await res.json();

                if (notes.length === 0) {
                    notesContainer.innerHTML = '<p class="text-muted">No notes uploaded yet for this subject.</p>';
                    deleteAllBtn.disabled = true;
                    return;
                }

                deleteAllBtn.disabled = false;

                const list = document.createElement("ul");
                list.className = "list-group";

                notes.forEach(note => {
                    const li = document.createElement("li");
                    li.className = "list-group-item d-flex justify-content-between align-items-center";
                    li.innerHTML = `
                <a href="/api/notes/${note.id}/preview" target="_blank">${note.file_name}</a>
                <button class="btn btn-sm btn-danger">Delete</button>
            `;

                    // ‚úÖ Delete single note
                    li.querySelector("button").addEventListener("click", async () => {
                        if (confirm(`Delete "${note.file_name}"?`)) {
                            await fetch(`/api/notes/${note.id}`, { method: "DELETE" });
                            renderNotes();
                        }
                    });

                    list.appendChild(li);
                });

                notesContainer.appendChild(list);
            } catch (err) {
                console.error("üî• Error fetching notes:", err);
                notesContainer.innerHTML = '<p class="text-danger">Failed to load notes.</p>';
            }
        }


        // 5Ô∏è‚É£ Delete all notes for current selection
        deleteAllBtn.addEventListener("click", async () => {
            const semester = semesterSelect.value;
            const section = sectionSelect.value;
            const subject = subjectSelect.value;

            if (confirm("Delete ALL notes for this subject?")) {
                try {
                    await fetch(`/api/notes`, {
                        method: "DELETE",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ semester, section, subject })
                    });
                    renderNotes();
                } catch (err) {
                    console.error("üî• Error deleting all notes:", err);
                    alert("Failed to delete all notes.");
                }
            }
        });
        function goHome() {
            window.location.href = "facultyHome.html";
        }
    </script>


</body>

</html>
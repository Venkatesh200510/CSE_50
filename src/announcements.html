<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üì¢ All Announcements</title>
  <link href="./output.css" rel="stylesheet">
</head>

<body class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 min-h-screen text-gray-900">

  <div class="max-w-7xl mx-auto py-12 px-6">
    <!-- Heading -->
    <h1 class="text-4xl md:text-5xl font-extrabold text-center text-white drop-shadow mb-6">
      Notifications & Announcements
    </h1>

    <!-- Sort Dropdown -->
    <div class="flex justify-center mb-8">
      <select id="sortType"
        class="p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white/90 shadow">
        <option value="All" selected>All Types</option>
        <option value="Placement">Placement</option>
        <option value="Result">Result</option>
        <option value="Events">Events</option>
        <option value="Alerts">Alerts</option>
        <option value="General">General</option>
      </select>
    </div>

    <!-- Announcements Container -->
    <div id="announcements-container" class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
      <!-- Dynamic cards will load here -->
    </div>
  </div>

  <script>
    let allAnnouncements = [];

    // Load announcements from API
    async function loadAnnouncements() {
      try {
        const res = await fetch("/api/announcements");
        if (!res.ok) throw new Error("Failed to fetch announcements");

        allAnnouncements = await res.json();
        renderAnnouncements(allAnnouncements);
      } catch (err) {
        console.error("Error loading announcements:", err);
        document.getElementById("announcements-container").innerHTML = `
          <div class="col-span-full text-center text-white bg-white/20 backdrop-blur p-6 rounded-2xl shadow-lg">
            ‚ö†Ô∏è Failed to load announcements.
          </div>`;
      }
    }

    // Render announcement cards
    function renderAnnouncements(announcements) {
      const container = document.getElementById("announcements-container");
      container.innerHTML = "";

      if (!announcements || announcements.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center text-white bg-white/20 backdrop-blur p-6 rounded-2xl shadow-lg">
            No announcements available üì≠
          </div>`;
        return;
      }

      announcements.forEach(a => {
        let fileSection = "";

        if (a.file_url) {
          if (a.file_type && a.file_type.startsWith("image/")) {
            fileSection = `
              <img src="${a.file_url}" class="rounded-xl shadow-md mt-4 max-h-52 w-full object-cover" alt="Announcement Image"/>`;
          } else if (a.file_type === "application/pdf") {
            fileSection = `
              <div class="mt-4">
                <object data="${a.file_url}" type="application/pdf"
                        class="w-full h-64 rounded-lg border"></object>
                <a href="${a.file_url}" download
                   class="mt-3 inline-block px-5 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow">
                   ‚¨á Download PDF
                </a>
              </div>`;
          } else {
            fileSection = `
              <a href="${a.file_url}" download
                 class="mt-4 inline-block px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow">
                 üìé Download File
              </a>`;
          }
        }

        // Color-coded type label
        let typeColor = "bg-gray-400";
        if (a.type === "Placement") typeColor = "bg-yellow-400";
        else if (a.type === "Events") typeColor = "bg-blue-400";
        else if (a.type === "Alerts") typeColor = "bg-red-400";
        else if (a.type === "Result") typeColor = "bg-orange-400";
        else if (a.type === "General") typeColor = "bg-green-400";

        const card = document.createElement("div");
        card.className =
          "bg-white/90 backdrop-blur rounded-2xl shadow-xl p-6 flex flex-col justify-between hover:scale-[1.02] transition-transform duration-200";

        card.innerHTML = `
          <div>
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-bold text-gray-800">${a.title}</h2>
              <span class="text-xs px-2 py-1 rounded ${typeColor} text-white">${a.type || "General"}</span>
            </div>
            <p class="text-xs text-gray-500 mt-1">
              By ${a.faculty_id || a.faculty_name || "Faculty"} ‚Ä¢ 
              ${new Date(a.created_at).toLocaleString()}
            </p>
            <p class="text-gray-700 mt-3 whitespace-pre-line">${a.message || ""}</p>
            ${fileSection}
          </div>
        `;

        container.appendChild(card);
      });
    }

    // Dropdown filter (case-insensitive)
    document.getElementById("sortType").addEventListener("change", (e) => {
      const type = e.target.value;
      if (type === "All") {
        renderAnnouncements(allAnnouncements);
      } else {
        const filtered = allAnnouncements.filter(
          (a) => a.type?.toLowerCase() === type.toLowerCase()
        );
        renderAnnouncements(filtered);
      }
    });

    // Load announcements when page loads
    document.addEventListener("DOMContentLoaded", loadAnnouncements);
  </script>
</body>

</html>
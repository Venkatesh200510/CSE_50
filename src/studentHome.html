<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Home</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
    <link href="./output.css" rel="stylesheet">
</head>

<body class="bg-blue-400 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-gray-800 text-white p-7 text-center shadow-md">
        <h1 class="text-3xl font-bold">Department Academic Management System</h1>
    </header>

    <!-- Profile Modal (Full Details) -->
    <div id="student-profile-card" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg w-96 p-6 relative shadow-lg">
            <!-- Close Button -->
            <button id="closeStudentProfile"
                class="absolute top-3 right-3 text-white w-6 h-6 rounded-full pb-1 bg-red-600 flex items-center justify-center">
                x
            </button>

            <!-- Profile Info -->
            <div class="text-center space-y-2">
                <div id="student-avatar"
                    class="w-14 h-14 mx-auto rounded-full bg-gray-800 flex items-center justify-center text-white text-xl font-bold">
                    ?
                </div>
                <h2 class="text-2xl font-bold text-gray-600" id="student-name">Loading...</h2>
                <p id="student-usn" class="text-gray-600"></p>
                <p id="student-section" class="text-gray-600"></p>
                <p id="student-sem" class="text-gray-600"></p>
                <p id="student-phone" class="text-gray-600"></p>
                <p id="student-email" class="text-gray-600"></p>

                <!-- Buttons -->
                <div class="mt-5 space-y-3">
                    <button id="studentChangePass"
                        class="bg-blue-500 text-white px-4 py-2 rounded w-40 hover:bg-blue-600">
                        Change Password
                    </button>
                    <form action="/logout" method="POST">
                        <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded w-40 hover:bg-red-600">
                            Logout
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Card (Quick Info) -->
    <div class="flex justify-between items-center p-4 bg-white shadow-md">
        <div id="openProfile"
            class="lg:m-20 lg:w-80 lg:p-6 bg-white shadow-xl rounded-xl cursor-pointer border border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Student Profile</h3>

            <!-- Avatar -->
            <div id="student-initials"
                class="w-14 h-14 mx-auto rounded-full bg-gray-800 flex items-center justify-center text-white text-xl font-bold mb-3">
                ?
            </div>

            <!-- Limited Fields -->
            <p id="card-student-name" class="text-center text-gray-700 font-bold leading-loose">Loading...</p>
            <p id="card-student-usn" class="text-center text-gray-600 text-sm"></p>
            <p id="card-student-sem" class="text-center text-gray-600 text-sm leading-loose"></p>
            <p id="card-student-section" class="text-center text-gray-600 text-sm"></p>
        </div>
        <!-- Recent Announcements -->
        <div id="recent-announcements"
            class="lg:m-20 bg-white shadow-xl rounded-xl w-100 p-7 cursor-pointer border border-gray-200">
            <h3 class="text-lg font-bold text-gray-800 mb-2">ðŸ“¢ Recent Announcements</h3>
            <ul id="recent-announcements-list" class="space-y-2 text-sm text-gray-700"></ul>
            <p class="text-blue-600 text-xs mt-3 text-right">Click to view all â†’</p>
        </div>
    </div>

    <!-- Main Section -->
    <main class="flex-grow flex items-center justify-center">
        <div class="grid grid-cols-3 gap-2 w-full max-w-4xl p-4 lg:gap-6">
            <a href="studentMarks.html"
                class="bg-white shadow-lg rounded-xl p-6 text-center hover:bg-blue-100 lg:w-60 lg:mr-3">
                <i class="fa-solid fa-chart-simple text-3xl mb-2"></i>
                <h2 class="font-semibold">Marks</h2>
            </a>

            <!-- Attendance -->
            <a href="studentAttendance.html"
                class="bg-white shadow-lg rounded-xl p-6 text-center hover:bg-blue-100 lg:w-60 lg:mr-3">
                <i class="fa-solid fa-calendar-week text-3xl mb-2"></i>
                <h2 class="font-semibold">Attendance</h2>
            </a>

            <!-- Notes -->
            <a href="viewNotes.html" class="bg-white shadow-lg rounded-xl p-6 text-center lg:w-60 hover:bg-blue-100">
                <i class="fa-solid fa-book text-3xl mb-2"></i>
                <h2 class="font-semibold">Notes</h2>
            </a>
        </div>
    </main>
    <!-- Contact Section -->
    <section id="contact" class="min-h-screen bg-pink-100 flex flex-col items-center justify-center px-6">
        <h2 class="text-3xl md:text-5xl font-bold leading-loose">Contact Us</h2>
        <input id="email" type="text" placeholder="Enter your email"
            class="mt-4 p-3 w-full max-w-md border border-gray-300 rounded">
        <textarea id="message" placeholder="Your message"
            class="mt-4 p-3 border border-gray-300 rounded w-full max-w-md h-32"></textarea>
        <button type="button" onclick="sendMessage()"
            class="mt-4 bg-blue-500 text-white px-6 py-3 rounded hover:bg-blue-600">
            Send Message
        </button>
        <div id="loading" class="w-12 h-12 mt-4 hidden">
            <img src="./images/spinner.svg" alt="Loading..." class="w-full h-full">
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="bg-gray-800 text-white text-center py-6">
            <p>&copy; 2023 CSE Department. All rights reserved.</p>
            <div class="flex justify-center space-x-4 mt-2">
                <a href="#" class="text-white hover:text-gray-400"><i class="fab fa-facebook"></i></a>
                <a href="#" class="text-white hover:text-gray-400"><i class="fab fa-envelope"></i></a>
                <a href="#" class="text-white hover:text-gray-400"><i class="fab fa-instagram"></i></a>
                <a href="#" class="text-white hover:text-gray-400"><i class="fab fa-linkedin"></i></a>
            </div>
        </div>
    </footer>

    <script>
        if (performance.navigation.type === 2) {
            location.reload(true);
        }

        document.addEventListener("DOMContentLoaded", () => {
            fetch("/api/profile")
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    // Fill Modal
                    document.getElementById("student-name").textContent = data.name;
                    document.getElementById("student-usn").textContent = `USN: ${data.usn}`;
                    document.getElementById("student-section").textContent = `Section: ${data.section}`;
                    document.getElementById("student-sem").textContent = `Semester: ${data.sem}`;
                    document.getElementById("student-phone").textContent = `Phone: ${data.phone}`;
                    document.getElementById("student-email").textContent = `Email: ${data.email}`;

                    // Fill Card
                    document.getElementById("card-student-name").textContent = data.name;
                    document.getElementById("card-student-usn").textContent = `USN: ${data.usn}`;
                    document.getElementById("card-student-section").textContent = `Section: ${data.section}`;
                    document.getElementById("card-student-sem").textContent = `Semester: ${data.sem}`;

                    // Initials
                    const initials = data.name
                        .split(" ")
                        .map(word => word[0]?.toUpperCase())
                        .slice(0, 2)
                        .join("");
                    document.getElementById("student-avatar").textContent = initials || "?";
                    document.getElementById("student-initials").textContent = initials || "?";
                })
                .catch(err => console.error("Error loading student profile:", err));

            // Modal handling
            document.getElementById("openProfile").addEventListener("click", () => {
                document.getElementById("student-profile-card").classList.remove("hidden");
            });
            document.getElementById("closeStudentProfile").addEventListener("click", () => {
                document.getElementById("student-profile-card").classList.add("hidden");
            });
            window.addEventListener("click", (e) => {
                const modal = document.getElementById("student-profile-card");
                if (e.target === modal) modal.classList.add("hidden");
            });

            // Change Password
            document.getElementById("studentChangePass").addEventListener("click", () => {
                window.location.href = "changepass.html";
            });

            loadRecentAnnouncements();
        });

        async function sendMessage() {
            const email = document.getElementById('email').value;
            const message = document.getElementById('message').value;
            const button = document.querySelector('button[onclick="sendMessage()"]');
            const loader = document.getElementById('loading');

            loader.classList.remove('hidden');
            button.disabled = true;

            try {
                const res = await fetch("/contact", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, message }),
                });

                const data = await res.json();

                if (data.success) {
                    alert("Message sent!");
                    document.getElementById('email').value = '';
                    document.getElementById('message').value = '';
                } else {
                    alert(data.error);
                }
            } catch (err) {
                alert("Error sending message. Try again later.");
                console.error(err);
            } finally {
                loader.classList.add('hidden');
                button.disabled = false;
            }
        }

        async function loadRecentAnnouncements() {
            try {
                const res = await fetch("/api/announcements");
                const announcements = await res.json();

                const list = document.getElementById("recent-announcements-list");
                list.innerHTML = "";

                const recent = announcements.slice(0, 5);

                if (recent.length === 0) {
                    list.innerHTML = `<li class="text-gray-500">No announcements yet.</li>`;
                    return;
                }

                recent.forEach(a => {
                    const li = document.createElement("li");
                    li.className = "truncate";
                    li.innerHTML = `<span class="font-semibold">${a.title}</span> - 
            <span class="text-gray-600">${a.message?.slice(0, 40) || ""}...</span>`;
                    list.appendChild(li);
                });

                document.getElementById("recent-announcements").addEventListener("click", () => {
                    window.location.href = "announcements.html";
                });

            } catch (err) {
                console.error("Error fetching recent announcements:", err);
            }
        }

        function goHome() {
            window.location.href = "home.html";
        }
    </script>
</body>

</html>